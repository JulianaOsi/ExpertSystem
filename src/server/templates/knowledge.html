<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <title>Title</title>

    <style type="text/css">
        body {
            padding-top: 5rem;
        }
        /* width */
        ::-webkit-scrollbar {
            width: 10px;
        }
        /* Track */
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #888;
        }
        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        p {
            cursor: pointer;
            /* display: none; */
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
    </script>

</head>
<body>
<ul class="nav justify-content-center">
    <li class="nav-item d-inline-flex">
        <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Knowledge base</a>
        <button id="saveBtn" class="btn btn-primary" type="button">Save</button>
    </li>
</ul>

<div k_id class="question-card card d-inline-flex shadow bg-white rounded" style="width: 20rem;">
    <div class="badge-primary p-2 text-center">Question</div>
    <div class="card-body p-2">
        <div class="list-group list-group-flush">
            <details class="list-group-item">
                <summary class="text-summary">text</summary>
                <div class="form-group">
                    <select name="questions" class="question-select form-control-sm">
                    </select>
                </div>
            </details>

            <details condition="true" class="list-group-item">
                <summary class="text-success">true</summary>
                <p class="create-question badge badge-primary">question</p>
                <p class="create-diagnosis badge badge-primary">diagnosis</p>
            </details>

            <details condition="false" class="list-group-item">
                <summary class="text-danger">false</summary>
                <p class="create-question badge badge-primary">question</p>
                <p class="create-diagnosis badge badge-primary">diagnosis</p>
            </details>
        </div>
    </div>
</div>

<div k_id class="diagnosis-card card d-inline-flex shadow bg-white rounded" style="width: 20rem;">
    <div class="badge-secondary p-2 text-center">Diagnosis</div>
    <div class="card-body p-2">
        <div class="list-group list-group-flush">
            <details class="list-group-item">
                <summary class="text-summary">text</summary>
                <div class="form-group">
                    <select name="diagnoses" class="diagnosis-select form-control-sm">
                    </select>
                </div>
            </details>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<script>
    var amount = parseInt("{{.Amount}}");
    var questionsDict;
    var diagnosesDict;

    var questionCard;
    var diagnosisCard;

    JQFUNS = {
        parseStrData: function (data) {
            var questionsSplit = data.split("\n");
            questionsSplit.pop();

            var map = {};
            for (var i = 0; i < questionsSplit.length; i++) {
                var keyValuePair = questionsSplit[i].split(".");
                for (var j = 0; j < keyValuePair.length; j++) {
                    map[parseInt(keyValuePair[0])] = keyValuePair[1];
                }
            }

            return map;
        }
        ,
        newCard: function (card, data) {
            var res = $(card).clone();

            var selection = res.find(".form-control-sm");

            Object.keys(data).forEach(function(key) {
                $( "<option></option>" )
                    .attr( 'value', key )
                    .text(data[key])
                    .appendTo( selection );
            });

            return res;
        }
        ,
        newQuestionCard: function () {
            return JQFUNS.newCard(questionCard, questionsDict);
        }
        ,
        newDiagnosisCard: function () {
            return JQFUNS.newCard(diagnosisCard, diagnosesDict);
        }
    }
    window.onload = function(){
        questionsDict = JQFUNS.parseStrData("{{range .Questions}}{{.Id}}.{{.Text}}\n{{end}}");
        diagnosesDict = JQFUNS.parseStrData("{{range .Diagnosis}}{{.Id}}.{{.Name}}\n{{end}}");

        var $temp = $( ".question-card" );
        questionCard = $temp.clone();
        $temp.remove();
        $temp = $( ".diagnosis-card" );
        diagnosisCard = $temp.clone();
        $temp.remove();
        var card = JQFUNS.newQuestionCard();
        card.insertAfter(".nav");
        card.attr("k_id", ++amount);
        $(".list-group").attr('depth', 0);
        // $("details").attr('open', "");
    };

    $(document).on('click', '.create-question', function () {
        $(this).parent().find(".badge").hide();

        var depth = parseInt($(this).parent().parent().attr("depth")) + 1;
        var newQuestion = JQFUNS.newQuestionCard();
        newQuestion.insertAfter(this);
        newQuestion.find(".list-group").attr("depth", depth);
        newQuestion.attr("k_id", ++amount);
    });

    $(document).on('click', '.create-diagnosis', function () {
        $(this).parent().find(".badge").hide();

        var depth = parseInt($(this).parent().parent().attr("depth")) + 1;
        var newDiagnosis = JQFUNS.newDiagnosisCard();
        newDiagnosis.insertAfter(this);
        newDiagnosis.find(".list-group").attr("depth", depth);
        newDiagnosis.attr("k_id", ++amount);
    });

    $(document).on('click', '.text-summary', function () {
        $(this).hide();
        // alert("text-summary");
        // $(this).next().children().mousedown();
    });

    $(document).on('change', ".diagnosis-select, .question-select", function () {
        var newText = $(this).find(":selected").text();
        var txtSummary = $(this).parent().prev();
        txtSummary.show();
        txtSummary.text(newText);
        txtSummary.parent().removeAttr("open");
    });

    jQuery('#saveBtn').click(function(event){
        event.preventDefault();
        // Grab all form data
        var formInputData = new Object();
        var cards = $("[k_id]");
        formInputData.knowledges = [];

        for (var i = 0; i < cards.length; i++) {
            var knowledge = new Object();
            knowledge.is_root = $(cards[i]).parent().is("body");
            knowledge.question = $(cards[i]).find("[name=questions]").first().val();

            if (typeof knowledge.question === 'undefined') {
                knowledge.question = null;
                knowledge.k_id_true = null;
                knowledge.k_id_false = null;
                knowledge.diagnosis = $(cards[i]).find("[name=diagnoses]").first().val();
                knowledge.diagnosis = (knowledge.diagnosis === undefined)? null : parseInt(knowledge.diagnosis);
            }
            else {
                knowledge.question = parseInt(knowledge.question);
                knowledge.k_id_true = $(cards[i]).find("[condition=true]").first().find(".card").first().attr("k_id");
                knowledge.k_id_true = (knowledge.k_id_true === undefined)? null : parseInt(knowledge.k_id_true);

                knowledge.k_id_false = $(cards[i]).children().last().children().last().children().last().find(".card").first().attr("k_id");
                knowledge.k_id_false = (knowledge.k_id_false === undefined)? null : parseInt(knowledge.k_id_false);

                knowledge.diagnosis = null;
            }

            formInputData.knowledges.push(knowledge);
        }

        var json_data = JSON.stringify(formInputData);
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "./add");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(json_data);
        alert("Данные сохранены");
    });
</script>

<!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
<!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script> -->

<!-- Option 2: jQuery, Popper.js, and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>

</body>
</html>